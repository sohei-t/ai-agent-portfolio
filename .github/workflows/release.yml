name: Release

on:
  push:
    tags:
      - '*-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract app name and version from tag
        id: info
        run: |
          TAG="${GITHUB_REF_NAME}"
          # {app-name}-v1.0.0 ‚Üí app-name, v1.0.0
          VERSION=$(echo "$TAG" | grep -oP 'v\d+\.\d+\.\d+$')
          APP_NAME="${TAG%-$VERSION}"
          DISPLAY_NAME=$(echo "$APP_NAME" | sed 's/-/ /g' | sed 's/\b\w/\U&/g')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "app_name=$APP_NAME" >> "$GITHUB_OUTPUT"
          echo "display_name=$DISPLAY_NAME" >> "$GITHUB_OUTPUT"
          echo "zipname=${APP_NAME}-${VERSION}.zip" >> "$GITHUB_OUTPUT"

      - name: Check app directory exists
        run: |
          if [ ! -d "${{ steps.info.outputs.app_name }}" ]; then
            echo "::error::Directory '${{ steps.info.outputs.app_name }}' not found"
            exit 1
          fi

      - name: Package app
        run: |
          cd "${{ steps.info.outputs.app_name }}"
          # Include all files except development artifacts
          zip -r "../${{ steps.info.outputs.zipname }}" . \
            -x "*.git*" \
            -x "node_modules/*" \
            -x "tests/*" \
            -x "test/*" \
            -x "__tests__/*" \
            -x "*.test.*" \
            -x "*.spec.*" \
            -x ".env*" \
            -x "*.log"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ steps.info.outputs.display_name }} ${{ steps.info.outputs.version }}"
          body: |
            ## ${{ steps.info.outputs.display_name }} ${{ steps.info.outputs.version }}

            ### „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éª‰Ωø„ÅÑÊñπ
            1. ‰∏ã„ÅÆ **${{ steps.info.outputs.zipname }}** „Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            2. zip „ÇíËß£Âáç
            3. `index.html` „Çí„Éñ„É©„Ç¶„Ç∂„ÅßÈñã„Åè

            ### „Ç™„É≥„É©„Ç§„É≥„ÅßË©¶„Åô
            - [Live Demo](https://sohei-t.github.io/ai-agent-portfolio/${{ steps.info.outputs.app_name }}/)
            - [About / Ëß£Ë™¨„Éö„Éº„Ç∏](https://sohei-t.github.io/ai-agent-portfolio/${{ steps.info.outputs.app_name }}/about.html)

            ---
            ü§ñ Generated by [git-worktree-agent](https://github.com/sohei-t/ai-agent-portfolio)
          files: ${{ steps.info.outputs.zipname }}
